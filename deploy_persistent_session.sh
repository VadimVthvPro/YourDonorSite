#!/bin/bash

# ============================================
# –¢–≤–æ–π –î–æ–Ω–æ—Ä - –î–µ–ø–ª–æ–π Persistent-—Å–µ—Å—Å–∏–∏
# ============================================
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è persistent-—Å–µ—Å—Å–∏–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
# –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã).
#
# –ê–≤—Ç–æ—Ä: AI Assistant
# –î–∞—Ç–∞: 2026-01-26
# ============================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
SERVER_IP="178.172.212.221"
SERVER_USER="root"
SERVER_PATH="/opt/tvoydonor/website"

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë   üöÄ DEPLOY PERSISTENT-–°–ï–°–°–ò–Ø         ‚ïë${NC}"
echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "website/js" ]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞!${NC}"
    exit 1
fi

echo -e "${BLUE}üìã –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:${NC}"
echo "  1. website/js/auth-storage.js (–ù–û–í–´–ô)"
echo "  2. website/js/auth.js (–æ–±–Ω–æ–≤–ª—ë–Ω)"
echo "  3. website/js/donor-dashboard.js (–æ–±–Ω–æ–≤–ª—ë–Ω)"
echo "  4. website/js/medcenter-dashboard.js (–æ–±–Ω–æ–≤–ª—ë–Ω)"
echo "  5. website/pages/auth.html (–æ–±–Ω–æ–≤–ª—ë–Ω)"
echo "  6. website/pages/donor-dashboard.html (–æ–±–Ω–æ–≤–ª—ë–Ω)"
echo "  7. website/pages/medcenter-dashboard.html (–æ–±–Ω–æ–≤–ª—ë–Ω)"
echo ""

# ============================================
# –®–ê–ì 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# ============================================

echo -e "${YELLOW}üì§ –®–ê–ì 1/3: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...${NC}"

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º auth-storage.js..."
scp website/js/auth-storage.js ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/js/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º auth.js..."
scp website/js/auth.js ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/js/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º donor-dashboard.js..."
scp website/js/donor-dashboard.js ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/js/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º medcenter-dashboard.js..."
scp website/js/medcenter-dashboard.js ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/js/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º auth.html..."
scp website/pages/auth.html ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/pages/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º donor-dashboard.html..."
scp website/pages/donor-dashboard.html ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/pages/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º medcenter-dashboard.html..."
scp website/pages/medcenter-dashboard.html ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/pages/

echo -e "${GREEN}‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã${NC}"
echo ""

# ============================================
# –®–ê–ì 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –∫—ç—à–∞ (cache-busting)
# ============================================

echo -e "${YELLOW}üîÑ –®–ê–ì 2/3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –¥–ª—è cache-busting...${NC}"

TIMESTAMP=$(date +%s)
echo "  ‚Ä¢ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${TIMESTAMP}"

ssh ${SERVER_USER}@${SERVER_IP} << EOF
    cd ${SERVER_PATH}
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ config.js
    sed -i "s/window.VERSION = .*/window.VERSION = '${TIMESTAMP}';/" js/config.js
    
    echo "‚úÖ –í–µ—Ä—Å–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
EOF

echo -e "${GREEN}‚úÖ Cache-busting –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
echo ""

# ============================================
# –®–ê–ì 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
# ============================================

echo -e "${YELLOW}üîÑ –®–ê–ì 3/3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx...${NC}"

ssh ${SERVER_USER}@${SERVER_IP} << 'EOF'
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
    nginx -t
    
    if [ $? -eq 0 ]; then
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
        systemctl reload nginx
        echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!"
        exit 1
    fi
EOF

echo -e "${GREEN}‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω${NC}"
echo ""

# ============================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢
# ============================================

echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${GREEN}‚ïë   ‚úÖ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û!         ‚ïë${NC}"
echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

echo -e "${BLUE}üìä –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:${NC}"
echo "  ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª: auth-storage.js"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã 3 JS —Ñ–∞–π–ª–∞ (auth, donor-dashboard, medcenter-dashboard)"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã 3 HTML —Ñ–∞–π–ª–∞ (–ø–æ–¥–∫–ª—é—á—ë–Ω auth-storage.js)"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤–µ—Ä—Å–∏–∏ –¥–ª—è cache-busting"
echo "  ‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
echo ""

echo -e "${BLUE}üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:${NC}"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ: https://tvoydonor.by"
echo "  2. –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å (–¥–æ–Ω–æ—Ä –∏–ª–∏ –º–µ–¥—Ü–µ–Ω—Ç—Ä)"
echo "  3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'üîê auth-storage.js –ó–ê–ì–†–£–ñ–ï–ù'"
echo "  4. –ù–∞–∂–º–∏—Ç–µ F5 (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)"
echo "  5. –î–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ (–ù–ï —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login)"
echo "  6. –ó–∞–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–Ω–æ–≤–∞"
echo "  7. –°–Ω–æ–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ"
echo ""

echo -e "${YELLOW}‚ö†Ô∏è  –í–ê–ñ–ù–û:${NC}"
echo "  ‚Ä¢ –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é, –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+R)"
echo "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"
echo "  ‚Ä¢ –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f /var/log/tvoydonor-api.err.log"
echo ""

echo -e "${GREEN}üéâ –ì–æ—Ç–æ–≤–æ! –°–µ—Å—Å–∏—è —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏!${NC}"
