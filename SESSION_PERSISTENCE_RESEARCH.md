# üîê –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: Persistent-—Å–µ—Å—Å–∏—è

## üìä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –¢–ï–ö–£–©–ï–ô –°–ò–°–¢–ï–ú–´

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è |
|----------|---------|-------------|
| **–°–µ—Å—Å–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ F5** | –¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `localStorage`, –Ω–æ **–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç login screen |
| **–í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏** | `localStorage` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–æ **–Ω–µ—Ç auto-restore –ª–æ–≥–∏–∫–∏** | –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ |
| **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ** | `checkAuth()` —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç **–Ω–∞–ª–∏—á–∏–µ**, –Ω–æ **–Ω–µ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å** —Ç–æ–∫–µ–Ω–∞ | –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏—Å—Ç—ë–∫—à–∏–π —Ç–æ–∫–µ–Ω |

---

## üîç –ê–£–î–ò–¢ –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø

### 1. –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–∫–µ–Ω –°–ï–ô–ß–ê–°

**Frontend (localStorage):**
```javascript
// –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ (auth.js:711-713)
localStorage.setItem('auth_token', result.token);
localStorage.setItem('user_type', 'donor');  // –∏–ª–∏ 'medcenter'
localStorage.setItem('donor_user', JSON.stringify(result.user));
```

**Backend (PostgreSQL - —Ç–∞–±–ª–∏—Ü–∞ `user_sessions`):**
```sql
CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,                    -- –¥–ª—è –¥–æ–Ω–æ—Ä–æ–≤
    medical_center_id INTEGER,          -- –¥–ª—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–æ–≤
    session_token VARCHAR(256) UNIQUE,  -- 64-—Å–∏–º–≤–æ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
    user_type VARCHAR(20),              -- 'donor' | 'medcenter'
    created_at TIMESTAMP,
    expires_at TIMESTAMP,               -- TTL: 7 –¥–Ω–µ–π (–¥–æ–Ω–æ—Ä), 24 —á–∞—Å–∞ (–º–µ–¥—Ü–µ–Ω—Ç—Ä)
    is_active BOOLEAN
);
```

**–¢–∏–ø —Ç–æ–∫–µ–Ω–∞:** Session ID (–Ω–µ JWT), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `secrets.token_urlsafe(64)`

---

### 2. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–î–æ–Ω–æ—Ä (donor-dashboard.js:11-16):**
```javascript
document.addEventListener('DOMContentLoaded', function() {
    if (!checkAuth()) {  // ‚ùå –¢–û–õ–¨–ö–û –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ù–ê–õ–ò–ß–ò–ï
        window.location.href = 'auth.html';
        return;
    }
    // ... init
});

function checkAuth() {
    return localStorage.getItem('user_type') === 'donor';  // ‚ö†Ô∏è –ù–ï –í–ê–õ–ò–î–ò–†–£–ï–¢!
}
```

**–ú–µ–¥—Ü–µ–Ω—Ç—Ä (medcenter-dashboard.js:40-44):**
```javascript
if (!checkAuth()) {
    window.location.href = 'auth.html?type=medcenter';
    return;
}

function checkAuth() {
    return localStorage.getItem('user_type') === 'medcenter';  // ‚ö†Ô∏è –ù–ï –í–ê–õ–ò–î–ò–†–£–ï–¢!
}
```

**‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ **–Ω–∞–ª–∏—á–∏–µ** `user_type` –≤ localStorage
- **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è** –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å `auth_token` –Ω–∞ backend
- **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è** –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Ç–æ–∫–µ–Ω
- **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è** `is_active` —Å–µ—Å—Å–∏–∏

---

### 3. –¢–µ–∫—É—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏

–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–¢–û–õ–¨–ö–û** –ø—Ä–∏ API-–∑–∞–ø—Ä–æ—Å–∞—Ö —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@require_auth`:

```python
# backend/app.py:217-243
def require_auth(user_type=None):
    def decorator(f):
        def decorated(*args, **kwargs):
            token = request.headers.get('Authorization', '').replace('Bearer ', '')
            
            if not token:
                return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401
            
            session = query_db(
                """SELECT * FROM user_sessions 
                   WHERE session_token = %s 
                   AND is_active = TRUE 
                   AND expires_at > NOW()""",
                (token,), one=True
            )
            
            if not session:
                return jsonify({'error': '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞'}), 401
            
            if user_type and session['user_type'] != user_type:
                return jsonify({'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω'}), 403
            
            g.session = session
            return f(*args, **kwargs)
        return decorated
    return decorator
```

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:** –í–∞–ª–∏–¥–∞—Ü–∏—è **–æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è** (lazy), –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º API-–≤—ã–∑–æ–≤–µ.

**–ü—Ä–∏–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ–ª–æ–º–∫–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä
2. –ü—Ä–æ—Ö–æ–¥–∏—Ç 7 –¥–Ω–µ–π ‚Üí —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç –Ω–∞ backend
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä
4. `checkAuth()` ‚Üí `true` (—Ç–æ–∫–µ–Ω –µ—Å—Ç—å –≤ localStorage)
5. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç UI
6. –ü–µ—Ä–≤—ã–π API-–∑–∞–ø—Ä–æ—Å ‚Üí 401 UNAUTHORIZED ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–º–∏–≥–∞–Ω–∏–µ" UI (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è dashboard ‚Üí —Ä–µ–∑–∫–æ –ø–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–∞ login)

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï

### –ü–æ–¥—Ö–æ–¥: **Proactive Token Validation + localStorage**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| **–•—Ä–∞–Ω–∏–ª–∏—â–µ** | localStorage (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **—Å—Ä–∞–∑—É** –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ backend |
| **Fallback** | –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Üí –æ—á–∏—â–∞–µ–º localStorage ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login |
| **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** | ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ backend, —Ä–∞–±–æ—Ç–∞–µ–º —Å —Ç–µ–∫—É—â–∏–º API |

### –ü–æ—á–µ–º—É –ù–ï Telegram Mini App?

- –í –ø—Ä–æ–µ–∫—Ç–µ **–ù–ï–¢** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram Mini App SDK
- –ù–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–π `Telegram.WebApp` –∏–ª–∏ `CloudStorage`
- –°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ** –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è **–∏–∑ —Å—Å—ã–ª–∫–∏ –≤ Telegram-–±–æ—Ç–µ**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è TG Mini App

---

## üìê –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø

### 1. Storage Adapter (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

```javascript
/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Ç–æ–∫–µ–Ω–æ–≤
 * –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
 */
class AuthStorage {
    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static save(token, userType, userData) {
        try {
            localStorage.setItem('auth_token', token);
            localStorage.setItem('user_type', userType);
            localStorage.setItem(`${userType}_user`, JSON.stringify(userData));
            console.log('‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', userType);
            return true;
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', e);
            return false;
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
     */
    static getToken() {
        return localStorage.getItem('auth_token');
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static getUserType() {
        return localStorage.getItem('user_type');
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static getUserData() {
        const userType = this.getUserType();
        if (!userType) return null;
        
        const key = `${userType}_user`;
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏
     */
    static hasSession() {
        return !!(this.getToken() && this.getUserType());
    }
    
    /**
     * –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏
     */
    static clear() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_type');
        localStorage.removeItem('donor_user');
        localStorage.removeItem('medcenter_user');
        console.log('üóëÔ∏è –°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞');
    }
    
    /**
     * –ù–û–í–û–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –Ω–∞ backend
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏ –Ω–µ –∏—Å—Ç—ë–∫
     */
    static async validate() {
        const token = this.getToken();
        const userType = this.getUserType();
        
        if (!token || !userType) {
            return { valid: false, reason: 'no_token' };
        }
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ endpoint –ø—Ä–æ—Ñ–∏–ª—è
            const endpoint = userType === 'donor' 
                ? `${API_URL}/donor/profile`
                : `${API_URL}/medcenter/profile`;
            
            const response = await fetch(endpoint, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                // –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userData = await response.json();
                localStorage.setItem(`${userType}_user`, JSON.stringify(userData));
                return { valid: true, userData };
            } else if (response.status === 401 || response.status === 403) {
                // –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
                console.warn('‚ö†Ô∏è –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫');
                return { valid: false, reason: 'token_expired' };
            } else {
                // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                return { valid: true, offline: true };
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞:', error);
            // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º (offline mode)
            return { valid: true, offline: true };
        }
    }
}
```

---

### 2. Auth Flow Integration

#### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: **proactive checkAuth**

```javascript
/**
 * –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞–∂–¥–æ–≥–æ dashboard
 * 
 * @returns {Promise<boolean>} true –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, false –∏–Ω–∞—á–µ
 */
async function checkAuthAndRestore() {
    console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
    
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏
    if (!AuthStorage.hasSession()) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏');
        return false;
    }
    
    // 2. –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ backend
    const validation = await AuthStorage.validate();
    
    if (validation.valid) {
        console.log('‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, —Å–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        
        if (validation.offline) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä offline mode
            showNotification('–†–∞–±–æ—Ç–∞–µ–º –≤ –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ', 'info');
        }
        
        return true;
    } else {
        // 3. –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Üí –æ—á–∏—â–∞–µ–º –≤—Å—ë
        console.warn('‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –æ—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é');
        AuthStorage.clear();
        return false;
    }
}
```

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è dashboards

**–î–æ–Ω–æ—Ä:**
```javascript
// donor-dashboard.js
document.addEventListener('DOMContentLoaded', async function() {
    // –ù–û–í–û–ï: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    const isAuth = await checkAuthAndRestore();
    
    if (!isAuth) {
        window.location.href = 'auth.html';
        return;
    }
    
    // –û—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
    initNavigation();
    initMobileSidebar();
    // ...
});
```

**–ú–µ–¥—Ü–µ–Ω—Ç—Ä:**
```javascript
// medcenter-dashboard.js
document.addEventListener('DOMContentLoaded', async function() {
    console.log('=== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è dashboard –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞ ===');
    
    // –ù–û–í–û–ï: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    const isAuth = await checkAuthAndRestore();
    
    if (!isAuth) {
        window.location.href = 'auth.html?type=medcenter';
        return;
    }
    
    console.log('‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è OK');
    // –û—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
});
```

---

### 3. Migration Strategy (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

**‚úÖ –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø!**

–ü–æ—á–µ–º—É:
- –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `localStorage` ‚Üí –Ω–µ –º–µ–Ω—è–µ–º –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ú–µ–Ω—è–µ–º **—Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏** –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–∏–∫–∞–∫–∏—Ö breaking changes

---

## üìù PLAN –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|------|-----------|-----------|
| `website/js/auth-storage.js` | **–ù–û–í–´–ô** ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π Storage Adapter | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| `website/js/donor-dashboard.js` | –ó–∞–º–µ–Ω–∞ `checkAuth()` –Ω–∞ `checkAuthAndRestore()` | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| `website/js/medcenter-dashboard.js` | –ó–∞–º–µ–Ω–∞ `checkAuth()` –Ω–∞ `checkAuthAndRestore()` | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô |
| `website/index.html` | –î–æ–±–∞–≤–∏—Ç—å `<script src="js/auth-storage.js">` | üü° –í–ê–ñ–ù–´–ô |
| `website/pages/donor-dashboard.html` | –î–æ–±–∞–≤–∏—Ç—å `<script src="../js/auth-storage.js">` | üü° –í–ê–ñ–ù–´–ô |
| `website/pages/medcenter-dashboard.html` | –î–æ–±–∞–≤–∏—Ç—å `<script src="../js/auth-storage.js">` | üü° –í–ê–ñ–ù–´–ô |

---

## üß™ TESTING CHECKLIST

| –°—Ü–µ–Ω–∞—Ä–∏–π | –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|---------------------|--------|
| **–ë—Ä–∞—É–∑–µ—Ä: F5** | –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, dashboard –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è | ‚è≥ |
| **–ë—Ä–∞—É–∑–µ—Ä: –∑–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É ‚Üí –æ—Ç–∫—Ä—ã—Ç—å** | –°–µ—Å—Å–∏—è –∂–∏–≤–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ | ‚è≥ |
| **–ë—Ä–∞—É–∑–µ—Ä: –∑–∞–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä ‚Üí –æ—Ç–∫—Ä—ã—Ç—å** | –°–µ—Å—Å–∏—è –∂–∏–≤–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ | ‚è≥ |
| **–ò—Å—Ç—ë–∫—à–∏–π —Ç–æ–∫–µ–Ω (7+ –¥–Ω–µ–π)** | –û—á–∏—â–∞–µ—Ç—Å—è localStorage, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login | ‚è≥ |
| **Logout** | –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ localStorage, —Ä–µ–¥–∏—Ä–µ–∫—Ç | ‚è≥ |
| **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** | –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, —á–∏—Å—Ç–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | ‚è≥ |
| **Offline mode** | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, —Ä–∞–±–æ—Ç–∞ —Å –∫—ç—à–µ–º | ‚è≥ |
| **–°–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** | –°—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é | ‚è≥ |

---

## üöÄ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –†–ï–®–ï–ù–ò–Ø

| –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ |
|--------------|------------|
| ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** | –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ backend, —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç |
| ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–∞ backend –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ |
| ‚úÖ **UX –±–µ–∑ "–º–∏–≥–∞–Ω–∏–π"** | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ **–î–û** –ø–æ–∫–∞–∑–∞ UI, –Ω–µ—Ç —Ä–µ–∑–∫–∏—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ |
| ‚úÖ **Offline mode** | –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (fallback –Ω–∞ –∫—ç—à) |
| ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** | –ù–µ –Ω—É–∂–Ω—ã cookies, –Ω–µ –Ω—É–∂–µ–Ω refresh-—Ç–æ–∫–µ–Ω, –Ω–µ –Ω—É–∂–µ–Ω JWT |
| ‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** | –ï–¥–∏–Ω—ã–π API –¥–ª—è –¥–æ–Ω–æ—Ä–æ–≤ –∏ –º–µ–¥—Ü–µ–Ω—Ç—Ä–æ–≤ |

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### XSS Protection

**–ü—Ä–æ–±–ª–µ–º–∞:** localStorage —É—è–∑–≤–∏–º –∫ XSS-–∞—Ç–∞–∫–∞–º

**Mitigation:**
1. ‚úÖ Backend —É–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `@require_auth`
2. ‚úÖ –¢–æ–∫–µ–Ω –∏–º–µ–µ—Ç TTL (expires_at)
3. ‚úÖ –¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (is_active = FALSE)
4. üîú **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å CSP (Content Security Policy) –≤ Nginx

### Session Hijacking Protection

**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∫—Ä–∞–¥–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**Mitigation (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –±—É–¥—É—â–µ–≥–æ):**
1. –°–æ—Ö—Ä–∞–Ω—è—Ç—å `user_agent` –∏ `ip_address` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
2. –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Ö –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
3. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –° –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê–ú–ò

| –†–µ—à–µ–Ω–∏–µ | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã | –í–µ—Ä–¥–∏–∫—Ç |
|---------|-------|--------|---------|
| **localStorage + validation** ‚úÖ | –ü—Ä–æ—Å—Ç–æ—Ç–∞, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | XSS-—É—è–∑–≤–∏–º–æ—Å—Ç—å | **–í–´–ë–†–ê–ù–û** |
| HttpOnly Cookies | XSS-–∑–∞—â–∏—Ç–∞ | –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, CSRF, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ backend | ‚ùå Overkill |
| JWT —Å refresh-—Ç–æ–∫–µ–Ω–æ–º | Stateless backend | –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ backend, —Å–ª–æ–∂–Ω–æ—Å—Ç—å | ‚ùå –ò–∑–±—ã—Ç–æ—á–Ω–æ |
| IndexedDB | –ë–æ–ª—å—à–æ–π –æ–±—ä—ë–º | Async API, overkill –¥–ª—è —Ç–æ–∫–µ–Ω–∞ | ‚ùå –ù–µ –Ω—É–∂–Ω–æ |

---

## ‚è≠Ô∏è NEXT STEPS

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `auth-storage.js`
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `donor-dashboard.js`
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `medcenter-dashboard.js`
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –≤ HTML
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å deploy-—Å–∫—Ä–∏–ø—Ç
6. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
7. ‚è≥ Deploy –Ω–∞ —Å–µ—Ä–≤–µ—Ä

---

**–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏! üöÄ**
