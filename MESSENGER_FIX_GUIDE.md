# ๐ง ะะกะะะะะะะะะ ะะะกะกะะะะะะะ: ะะฝััััะบัะธั

## โ ะงะขะ ะะซะะ ะะะะะะฃะะะะ

### ๐ ะัะพะฒะตะดะตะฝะพ ะณะปัะฑะพะบะพะต ะธััะปะตะดะพะฒะฐะฝะธะต

ะคะฐะนะป: `MESSENGER_PROBLEMS_RESEARCH.md` โ ะฟะพะปะฝัะน ะฐะฝะฐะปะธะท ะฒัะตั ะฟัะพะฑะปะตะผ ะผะตััะตะฝะดะถะตัะฐ.

**ะะฑะฝะฐััะถะตะฝะพ 4 ะบัะธัะธัะตัะบะธั ะฟัะพะฑะปะตะผั:**

1. โ **ะะตัะพะพัะฒะตัััะฒะธะต ััะตะผั ะะ ะธ ะบะพะดะฐ**
   - ะ ะะ: `sender_role`, `message`
   - ะ ะบะพะดะต: `sender_type`, `message_text`, `message_type`
   - ะะตะทัะปััะฐั: Backend ะฟะธัะตั ะฒ ะฝะตัััะตััะฒัััะธะต ะบะพะปะพะฝะบะธ!

2. โ **format_message ะฒะพะทะฒัะฐัะฐะตั undefined**
   - ะััะฐะตััั ะฟัะพัะธัะฐัั `sender_type` ะธะท ะะ
   - ะะพ ะฒ ะะ ะตััั ัะพะปัะบะพ `sender_role`
   - ะะตะทัะปััะฐั: Frontend ะฟะพะปััะฐะตั `undefined` ะดะปั ะฒัะตั ะฟะพะปะตะน!

3. โ **renderMessage ะฝะต ะทะฝะฐะตั ะบัะพ ะพัะฟัะฐะฒะธัะตะปั**
   - `msg.sender_type` = `undefined`
   - `isOwn` ะฒัะตะณะดะฐ `false`
   - ะะตะทัะปััะฐั: ะะกะ ัะพะพะฑัะตะฝะธั ะพัะพะฑัะฐะถะฐัััั ัะปะตะฒะฐ!

4. โ **renderNotificationMessage ะธัะฟะพะปัะทัะตั sender_role**
   - ะ ะพะฑัะตะบัะต `msg` ะฝะตั ะฟะพะปั `sender_role`
   - `isOwn` = `false`
   - ะะตะทัะปััะฐั: ะะปะธัะธัะพะฒะฐะฝะฝัะต ัะพะพะฑัะตะฝะธั ะผะตะดัะตะฝััะฐ ะพัะพะฑัะฐะถะฐัััั ัะปะตะฒะฐ!

---

## โ ะงะขะ ะกะะะะะะ

### 1. ะกะพะทะดะฐะฝะฐ SQL ะผะธะณัะฐัะธั

**ะคะฐะนะป:** `migrate_chat_messages.sql`

**ะะทะผะตะฝะตะฝะธั ะฒ ะะ:**
```sql
-- ะะตัะตะธะผะตะฝะพะฒะฐะฝะธั
ALTER TABLE chat_messages RENAME COLUMN sender_role TO sender_type;
ALTER TABLE chat_messages RENAME COLUMN message TO message_text;

-- ะะพะฒัะต ะบะพะปะพะฝะบะธ
ALTER TABLE chat_messages ADD COLUMN message_type VARCHAR(50) DEFAULT 'text';
ALTER TABLE chat_messages ADD COLUMN metadata JSONB;
ALTER TABLE chat_messages ADD COLUMN read_at TIMESTAMP;
ALTER TABLE chat_messages ADD COLUMN edited_at TIMESTAMP;
ALTER TABLE chat_messages ADD COLUMN deleted_at TIMESTAMP;
```

**โ ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั:** ะะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัััั ัะฐะฑะปะธัะฐ `chat_messages_backup`

---

### 2. ะัะฟัะฐะฒะปะตะฝ frontend

**ะคะฐะนะป:** `website/js/messenger.js`

**ะะทะผะตะฝะตะฝะธั ะฒ `renderNotificationMessage`:**
```javascript
// โ ะะซะะ (ะฝะตะฒะตัะฝะพ):
const isOwn = msg.sender_role === this.userRole;

// โ ะกะขะะะ (ะฟัะฐะฒะธะปัะฝะพ):
const normalizedUserRole = this.userRole === 'medical_center' ? 'medcenter' : this.userRole;
const isOwn = msg.sender_type === normalizedUserRole;
```

---

### 3. ะกะพะทะดะฐะฝ ัะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะดะตะฟะปะพั

**ะคะฐะนะป:** `fix_messenger_display.sh`

**ะงัะพ ะดะตะปะฐะตั:**
1. ะะฐะณััะถะฐะตั ะผะธะณัะฐัะธั ะธ ะพะฑะฝะพะฒะปัะฝะฝัะน JS ะฝะฐ ัะตัะฒะตั
2. ะัะธะผะตะฝัะตั ะผะธะณัะฐัะธั ะบ ะะ (ั ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะตะน!)
3. ะะฑะฝะพะฒะปัะตั ะฒะตััะธะธ ะดะปั cache-busting
4. ะะตัะตะทะฐะฟััะบะฐะตั Nginx ะธ API

---

## ๐ ะะะ ะะกะะะะะะขะฌ

### ะะฐัะธะฐะฝั 1: ะะฒัะพะผะฐัะธัะตัะบะธะน (ัะตะบะพะผะตะฝะดัะตััั)

```bash
cd /Users/VadimVthv/Your_donor
./fix_messenger_display.sh
```

ะกะบัะธะฟั:
- ะกะพะทะดะฐัั ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะะ
- ะัะธะผะตะฝะธั ะผะธะณัะฐัะธั
- ะะฑะฝะพะฒะธั frontend
- ะะตัะตะทะฐะฟัััะธั ัะตัะฒะธัั

---

### ะะฐัะธะฐะฝั 2: ะะพัะฐะณะพะฒัะน (ะตัะปะธ ัะบัะธะฟั ะฝะต ัะฐะฑะพัะฐะตั)

#### ะจะฐะณ 1: ะะฐะณััะทะธัั ัะฐะนะปั

```bash
cd /Users/VadimVthv/Your_donor

# SQL ะผะธะณัะฐัะธั
scp migrate_chat_messages.sql root@178.172.212.221:/tmp/

# ะะฑะฝะพะฒะปัะฝะฝัะน JS
scp website/js/messenger.js root@178.172.212.221:/opt/tvoydonor/website/js/
```

#### ะจะฐะณ 2: ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธั ะะ

```bash
ssh root@178.172.212.221

# ะะพะดะบะปััะฐะตะผัั ะบ ะะ
sudo -u postgres psql -d your_donor

# ะัะธะผะตะฝัะตะผ ะผะธะณัะฐัะธั
\i /tmp/migrate_chat_messages.sql

# ะัะพะฒะตััะตะผ ััะตะผั
\d chat_messages

# ะะพะปะถะฝั ัะฒะธะดะตัั:
# - sender_type (ะฒะผะตััะพ sender_role)
# - message_text (ะฒะผะตััะพ message)
# - message_type (ะฝะพะฒะฐั ะบะพะปะพะฝะบะฐ)
```

#### ะจะฐะณ 3: ะะฑะฝะพะฒะธัั ะฒะตััะธั (cache-busting)

```bash
cd /opt/tvoydonor/website
TIMESTAMP=$(date +%s)
sed -i "s/window.VERSION = .*/window.VERSION = '${TIMESTAMP}';/" js/config.js

echo "ะะตััะธั: ${TIMESTAMP}"
```

#### ะจะฐะณ 4: ะะตัะตะทะฐะฟัััะธัั ัะตัะฒะธัั

```bash
nginx -t && systemctl reload nginx
supervisorctl restart tvoydonor-api
```

---

## ๐งช ะะะ ะะะะขะะกะขะะะะะะขะฌ

### ะขะตัั 1: ะะปะธัะธัะพะฒะฐะฝะฝะพะต ัะพะพะฑัะตะฝะธะต (ะฟัะธะณะปะฐัะตะฝะธะต)

1. **ะะฐะปะพะณะธะฝััะตัั ะบะฐะบ ะผะตะดัะตะฝัั**
2. **ะัะบัะพะนัะต ัะฐะทะดะตะป "ะัะบะปะธะบะธ"**
3. **ะะพะดัะฒะตัะดะธัะต ะดะพะฝะพัะฐ** (ะบะฝะพะฟะบะฐ "ะะพะดัะฒะตัะดะธัั")
   - ะะฒัะพะผะฐัะธัะตัะบะธ ะพัะฟัะฐะฒะธััั ะบะปะธัะธัะพะฒะฐะฝะฝะพะต ัะพะพะฑัะตะฝะธะต
4. **ะัะบัะพะนัะต ะผะตััะตะฝะดะถะตั**
5. โ **ะะะะะะะขะกะฏ:**
   - ะฃ ะผะตะดัะตะฝััะฐ: ะกะพะพะฑัะตะฝะธะต **ะกะะะะะ** (ัะฒะพั, ะบะปะฐัั `own`)
   - ะะฐะณะพะปะพะฒะพะบ: "โ ะัะธะณะปะฐัะตะฝะธะต ะฝะฐ ะดะพะฝะฐัะธั"
   - ะขะตะบัั ะฒะธะดะตะฝ, ะฝะต `undefined`

6. **ะะฐะปะพะณะธะฝััะตัั ะบะฐะบ ะดะพะฝะพั**
7. **ะัะบัะพะนัะต ะผะตััะตะฝะดะถะตั**
8. โ **ะะะะะะะขะกะฏ:**
   - ะฃ ะดะพะฝะพัะฐ: ะกะพะพะฑัะตะฝะธะต **ะกะะะะ** (ะพั ะผะตะดัะตะฝััะฐ, ะบะปะฐัั `other`)

---

### ะขะตัั 2: ะะฑััะฝะพะต ัะพะพะฑัะตะฝะธะต ะพั ะผะตะดัะตะฝััะฐ

1. **ะะตะดัะตะฝัั ะพัะฟัะฐะฒะปัะตั:** "ะัะธะฒะตั, ะบะพะณะดะฐ ัะผะพะถะตัะต ะฟัะธะนัะธ?"
2. โ **ะะะะะะะขะกะฏ:**
   - ะฃ ะผะตะดัะตะฝััะฐ: **ะกะะะะะ** (ัะฒะพั)
   - ะฃ ะดะพะฝะพัะฐ: **ะกะะะะ** (ะพั ะผะตะดัะตะฝััะฐ)

---

### ะขะตัั 3: ะะฑััะฝะพะต ัะพะพะฑัะตะฝะธะต ะพั ะดะพะฝะพัะฐ

1. **ะะพะฝะพั ะพัะฟัะฐะฒะปัะตั:** "ะะดัะฐะฒััะฒัะนัะต, ะทะฐะฒััะฐ ะฒ 10:00"
2. โ **ะะะะะะะขะกะฏ:**
   - ะฃ ะดะพะฝะพัะฐ: **ะกะะะะะ** (ัะฒะพั)
   - ะฃ ะผะตะดัะตะฝััะฐ: **ะกะะะะ** (ะพั ะดะพะฝะพัะฐ)

---

### ะขะตัั 4: ะัะพะฒะตัะบะฐ ะบะพะฝัะพะปะธ ะฑัะฐัะทะตัะฐ

1. ะัะบัะพะนัะต ะบะพะฝัะพะปั (F12 โ Console)
2. โ **ะะ ะดะพะปะถะฝะพ ะฑััั:**
   - `undefined` ะฒ ัะพะพะฑัะตะฝะธัั
   - ะัะธะฑะพะบ JS
   - 500 ะพัะธะฑะพะบ ะฒ Network

---

## ๐ ะะขะะะข ะะะะะะฆะะ (ะตัะปะธ ััะพ-ัะพ ะฟะพัะปะพ ะฝะต ัะฐะบ)

### ะะฐัะธะฐะฝั 1: ะงะตัะตะท SQL

```bash
ssh root@178.172.212.221
sudo -u postgres psql -d your_donor

DROP TABLE chat_messages;
ALTER TABLE chat_messages_backup RENAME TO chat_messages;
```

### ะะฐัะธะฐะฝั 2: ะงะตัะตะท ัะตะทะตัะฒะฝัั ะบะพะฟะธั

ะะธะณัะฐัะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัั ัะฐะฑะปะธัั `chat_messages_backup` ั ะบะพะฟะธะตะน ะฒัะตั ะดะฐะฝะฝัั **ะะ** ะธะทะผะตะฝะตะฝะธะน.

---

## ๐ ะะะะะะะกะขะะะ ะะะะะะะ

### ะัะพะฑะปะตะผะฐ 1: ะกะพะพะฑัะตะฝะธั ะฒัั ะตัั ะพัะพะฑัะฐะถะฐัััั ะฝะตะฟัะฐะฒะธะปัะฝะพ

**ะัะธัะธะฝะฐ:** ะัะฐัะทะตัะฝัะน ะบัั

**ะะตัะตะฝะธะต:**
1. ะัะธััะธัะต ะบัั: **Ctrl + Shift + R** (Win) ะธะปะธ **Cmd + Shift + R** (Mac)
2. ะัะพะฒะตัััะต ะฒะตััะธั ะฒ ะบะพะฝัะพะปะธ:
   ```javascript
   console.log(window.VERSION);
   ```
3. ะะพะปะถะฝะฐ ะฑััั ะฝะพะฒะฐั ะฒะตััะธั (timestamp)

---

### ะัะพะฑะปะตะผะฐ 2: ะัะธะฑะบะฐ "column sender_type does not exist"

**ะัะธัะธะฝะฐ:** ะะธะณัะฐัะธั ะฝะต ะฟัะธะผะตะฝะธะปะฐัั

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ััะตะผั ะะ:
   ```bash
   ssh root@178.172.212.221
   sudo -u postgres psql -d your_donor -c "\d chat_messages"
   ```
2. ะัะปะธ ะฒะธะดะธัะต `sender_role` โ ะผะธะณัะฐัะธั ะฝะต ะฟัะธะผะตะฝะตะฝะฐ
3. ะัะธะผะตะฝะธัะต ะฒัััะฝัั: `/tmp/migrate_chat_messages.sql`

---

### ะัะพะฑะปะตะผะฐ 3: ะกะพะพะฑัะตะฝะธั ะฟััััะต (ะฝะตั ัะตะบััะฐ)

**ะัะธัะธะฝะฐ:** `format_message` ัะธัะฐะตั ะฝะตะฒะตัะฝะพะต ะฟะพะปะต

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ััะพ ะฒ ะะ ะตััั ะบะพะปะพะฝะบะฐ `message_text`:
   ```sql
   SELECT column_name FROM information_schema.columns 
   WHERE table_name = 'chat_messages';
   ```
2. ะะพะปะถะฝะฐ ะฑััั `message_text` (ะฝะต `message`)

---

## ๐ ะะะะฃะะะฌะะะ ะกะะะะะะะะ

### ะะ ะธัะฟัะฐะฒะปะตะฝะธั:

```
ะะะะฆะะะขะ ะะะะะข:
โโโโโโโโโโโโโโโโโโโโโโโ
โ [ะัะธะฒะตั]            โ โ ะกะฒะพั ัะพะพะฑัะตะฝะธะต ะกะะะะ (ะฝะตะฒะตัะฝะพ!)
โโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโ
โ [โ ะัะธะณะปะฐัะตะฝะธะต]    โ โ ะะปะธัะธัะพะฒะฐะฝะฝะพะต ะกะะะะ (ะฝะตะฒะตัะฝะพ!)
โโโโโโโโโโโโโโโโโโโโโโโ

ะะะะะ ะะะะะข:
โโโโโโโโโโโโโโโโโโโโโโโ
โ [โ ะัะธะณะปะฐัะตะฝะธะต]    โ โ ะั ะผะตะดัะตะฝััะฐ ะกะะะะ (ะฟัะฐะฒะธะปัะฝะพ)
โโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะะกะะ ะธัะฟัะฐะฒะปะตะฝะธั:

```
ะะะะฆะะะขะ ะะะะะข:
           โโโโโโโโโโโโโโโโโโโโโโโ
           โ [ะัะธะฒะตั]            โ โ ะกะฒะพั ัะพะพะฑัะตะฝะธะต ะกะะะะะ โ
           โโโโโโโโโโโโโโโโโโโโโโโ
           โโโโโโโโโโโโโโโโโโโโโโโ
           โ [โ ะัะธะณะปะฐัะตะฝะธะต]    โ โ ะะปะธัะธัะพะฒะฐะฝะฝะพะต ะกะะะะะ โ
           โโโโโโโโโโโโโโโโโโโโโโโ

ะะะะะ ะะะะะข:
โโโโโโโโโโโโโโโโโโโโโโโ
โ [โ ะัะธะณะปะฐัะตะฝะธะต]    โ โ ะั ะผะตะดัะตะฝััะฐ ะกะะะะ โ
โโโโโโโโโโโโโโโโโโโโโโโ
           โโโโโโโโโโโโโโโโโโโโโโโ
           โ [ะฅะพัะพัะพ]            โ โ ะกะฒะพั ัะพะพะฑัะตะฝะธะต ะกะะะะะ โ
           โโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โ ะะขะะ

**ะัะฟัะฐะฒะปะตะฝะพ:**
- โ ะกัะตะผะฐ ะะ ะฟัะธะฒะตะดะตะฝะฐ ะฒ ัะพะพัะฒะตัััะฒะธะต ั ะบะพะดะพะผ
- โ `format_message` ัะตะฟะตัั ะฒะพะทะฒัะฐัะฐะตั ะบะพััะตะบัะฝัะต ะฟะพะปั
- โ `renderMessage` ะฟัะฐะฒะธะปัะฝะพ ะพะฟัะตะดะตะปัะตั ะพัะฟัะฐะฒะธัะตะปั
- โ `renderNotificationMessage` ะธัะฟะพะปัะทัะตั `sender_type`
- โ ะะปะธัะธัะพะฒะฐะฝะฝัะต ัะพะพะฑัะตะฝะธั ะพัะพะฑัะฐะถะฐัััั ั ะฟัะฐะฒะธะปัะฝะพะน ััะพัะพะฝั
- โ ะกะพะดะตัะถะธะผะพะต ัะพะพะฑัะตะฝะธะน ะฝะต `undefined`

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
- โ ะกะพะพะฑัะตะฝะธั ะพั ะผะตะดัะตะฝััะฐ โ **ัะฟัะฐะฒะฐ** (ั ะผะตะดัะตะฝััะฐ), **ัะปะตะฒะฐ** (ั ะดะพะฝะพัะฐ)
- โ ะกะพะพะฑัะตะฝะธั ะพั ะดะพะฝะพัะฐ โ **ัะฟัะฐะฒะฐ** (ั ะดะพะฝะพัะฐ), **ัะปะตะฒะฐ** (ั ะผะตะดัะตะฝััะฐ)
- โ ะะปะธัะธัะพะฒะฐะฝะฝัะต ัะพะพะฑัะตะฝะธั โ **ัะฟัะฐะฒะฐ** (ั ะผะตะดัะตะฝััะฐ), **ัะปะตะฒะฐ** (ั ะดะพะฝะพัะฐ)

---

**ะะฐะฟัััะธัะต ะดะตะฟะปะพะน:**
```bash
./fix_messenger_display.sh
```

**ะ ะฟัะพัะตััะธััะนัะต! ๐**
