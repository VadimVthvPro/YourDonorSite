#!/bin/bash

# ======================================================
# ๐ฏ ะะกะะะะะะะะะ: ะะฝะพะฟะบะฐ "ะะฐะฟัะพั ะฒัะฟะพะปะฝะตะฝ" 
# ======================================================
# ะะะะะะะะ:
#   โข ะะฝะพะฟะบะฐ ะฒัะทัะฒะฐะปะฐ ะฝะตัััะตััะฒััััั ััะฝะบัะธั markRequestFulfilled()
#   โข ะคัะฝะบัะธั fulfillRequest() ัััะตััะฒัะตั, ะฝะพ ะฝะต ะฒัะทัะฒะฐะปะฐัั
# 
# ะะะจะะะะ:
#   โข ะัะฟัะฐะฒะปะตะฝ onclick ะฝะฐ ะบะฝะพะฟะบะต "ะัะฟะพะปะฝะตะฝ"
#   โข ะขะตะฟะตัั ะฒัะทัะฒะฐะตััั ะฟัะฐะฒะธะปัะฝะฐั ััะฝะบัะธั fulfillRequest()
#
# ะะะฅะะะะะ:
#   1. ะะตะดัะตะฝัั ัะพะทะดะฐัั ะทะฐะฟัะพั
#   2. ะะพะฝะพัั ะพัะบะปะธะบะฐัััั
#   3. ะะตะดัะตะฝัั ะะะะขะะะะะะะะข ะดะพะฝะพัะพะฒ (confirmed)
#   4. ะะตะดัะตะฝัั ะฝะฐะถะธะผะฐะตั "ะะะะะะก ะะซะะะะะะ"
#   5. ะะะฏ ะะกะะฅ confirmed ะดะพะฝะพัะพะฒ:
#      - ะะฐะฟะธััะฒะฐะตััั ะดะพะฝะฐัะธั ะฒ donation_history
#      - ะะฑะฝะพะฒะปัะตััั ััะฐัะธััะธะบะฐ ะดะพะฝะพัะฐ (total_donations, total_volume_ml, last_donation_date)
#      - ะัะบะปะธะบ ะฟะตัะตัะพะดะธั ะฒ status='completed'
#   6. ะะฐะฟัะพั ะฟะตัะตัะพะดะธั ะฒ status='fulfilled'
# ======================================================

set -e

SERVER_IP="178.172.212.221"

echo -e "\n๐ฏ ะะกะะะะะะะะะ ะะะะะะ 'ะะะะะะก ะะซะะะะะะ'"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ะงัะพ ะฑัะดะตั ะธัะฟัะฐะฒะปะตะฝะพ:"
echo "  โ medcenter-dashboard.js - onclick ะฝะฐ ะบะฝะพะฟะบะต 'ะัะฟะพะปะฝะตะฝ'"
echo "  โ ะะตัะตะทะฐะณััะทะบะฐ frontend (cache busting)"
echo ""
echo "๐ง ะะตัะฐะฝะธะทะผ:"
echo "  1. ะะตะดัะตะฝัั ะฟะพะดัะฒะตัะถะดะฐะตั ะดะพะฝะพัะพะฒ (confirmed)"
echo "  2. ะะฐะถะธะผะฐะตั 'ะะฐะฟัะพั ะฒัะฟะพะปะฝะตะฝ'"
echo "  3. ะะะฏ ะะะะะะะ confirmed ะดะพะฝะพัะฐ:"
echo "     โข ะะฐะฟะธัั ะฒ donation_history"
echo "     โข ะะฑะฝะพะฒะปะตะฝะธะต users (total_donations, last_donation_date)"
echo "     โข donation_responses.status = 'completed'"
echo "  4. blood_requests.status = 'fulfilled'"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

read -p "ะัะพะดะพะปะถะธัั? (y/n): " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "โ ะัะผะตะฝะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ"
    exit 0
fi

echo -e "\n๐ค ะจะะ 1/3: ะะฐะณััะทะบะฐ ะธัะฟัะฐะฒะปะตะฝะฝะพะณะพ JS..."
scp website/js/medcenter-dashboard.js root@$SERVER_IP:/opt/tvoydonor/website/js/
echo "โ medcenter-dashboard.js ะทะฐะณััะถะตะฝ"

echo -e "\n๐ ะจะะ 2/3: ะะฑะฝะพะฒะปะตะฝะธะต ะฒะตััะธะธ (cache busting)..."
ssh root@$SERVER_IP "
    cd /opt/tvoydonor/website
    TIMESTAMP=\$(date +%s)
    sed -i \"s/window.VERSION = .*/window.VERSION = '\${TIMESTAMP}';/\" js/config.js
    echo \"โ ะะตััะธั ะพะฑะฝะพะฒะปะตะฝะฐ: \${TIMESTAMP}\"
"

echo -e "\n๐ ะจะะ 3/3: ะะตัะตะทะฐะณััะทะบะฐ nginx..."
ssh root@$SERVER_IP "
    nginx -t && systemctl reload nginx
    echo \"โ Nginx ะฟะตัะตะทะฐะณััะถะตะฝ\"
"

echo -e "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะะะะะะ ะะะะะะจะะ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐งช ะะะกะขะะฃะะฆะะฏ ะะ ะขะะกะขะะะะะะะะฎ:"
echo ""
echo "1๏ธโฃ  ะะฐะนะดะธัะต ะฒ ะบะฐะฑะธะฝะตั ะผะตะดัะตะฝััะฐ"
echo "2๏ธโฃ  ะะตัะตะนะดะธัะต ะฒ ัะฐะทะดะตะป 'ะะฐะฟัะพัั ะบัะพะฒะธ'"
echo "3๏ธโฃ  ะะฐะนะดะธัะต ะฐะบัะธะฒะฝัะน ะทะฐะฟัะพั ั ะฟะพะดัะฒะตัะถะดัะฝะฝัะผะธ ะดะพะฝะพัะฐะผะธ"
echo "4๏ธโฃ  ะะฐะถะผะธัะต ะบะฝะพะฟะบั 'ะะซะะะะะะ'"
echo "5๏ธโฃ  ะะพะดัะฒะตัะดะธัะต ะดะตะนััะฒะธะต"
echo ""
echo "๐ ะะะะะะะฌะขะ ะะะะฃะะฌะขะะข:"
echo "  โข ะะฐะฟัะพั ะดะพะปะถะตะฝ ะฟะตัะตะนัะธ ะฒ ััะฐััั 'ะัะฟะพะปะฝะตะฝ'"
echo "  โข ะฃ ะดะพะฝะพัะพะฒ ะดะพะปะถะฝะฐ ะพะฑะฝะพะฒะธัััั ััะฐัะธััะธะบะฐ:"
echo "    - ะะพะปะธัะตััะฒะพ ะดะพะฝะฐัะธะน +1"
echo "    - ะะฑััะผ ะบัะพะฒะธ +450 ะผะป"
echo "    - ะะฐัะฐ ะฟะพัะปะตะดะฝะตะน ะดะพะฝะฐัะธะธ = ัะตะณะพะดะฝั"
echo "  โข ะัะบะปะธะบะธ ะดะพะฝะพัะพะฒ ะดะพะปะถะฝั ะฟะตัะตะนัะธ ะฒ 'completed'"
echo ""
echo "๐ ะะะะะะะกะขะะะ (ะตัะปะธ ะฝะต ัะฐะฑะพัะฐะตั):"
echo "  ssh root@$SERVER_IP"
echo "  sudo -u postgres psql -d your_donor"
echo "  -- ะกะผะพััะธะผ donation_history:"
echo "  SELECT * FROM donation_history ORDER BY id DESC LIMIT 5;"
echo "  -- ะกะผะพััะธะผ ััะฐัะธััะธะบั ะดะพะฝะพัะฐ:"
echo "  SELECT id, full_name, total_donations, total_volume_ml, last_donation_date FROM users WHERE id = X;"
echo "  -- ะกะผะพััะธะผ ะพัะบะปะธะบะธ:"
echo "  SELECT id, user_id, request_id, status FROM donation_responses WHERE request_id = Y;"
echo ""
