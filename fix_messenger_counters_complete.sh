#!/bin/bash

echo "════════════════════════════════════════════════════════════════"
echo "🔧 КОМПЛЕКСНОЕ ИСПРАВЛЕНИЕ: СЧЁТЧИКИ + СОХРАНЕНИЕ"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "📋 ЧТО БУДЕТ СДЕЛАНО:"
echo "  1️⃣  Добавление колонок для счётчиков непрочитанных"
echo "  2️⃣  Пересчёт всех счётчиков из chat_messages"
echo "  3️⃣  Сохранение v40.1 в Git"
echo "  4️⃣  Документация по автообновлению (на рассмотрение)"
echo ""
echo "⚠️  ВАЖНО: Это НЕ сломает сайт!"
echo ""
read -p "Продолжить? (y/n): " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "❌ Отменено"
    exit 0
fi

cd /Users/VadimVthv/Your_donor

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 ШАГ 1: МИГРАЦИЯ БД НА СЕРВЕРЕ"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Загружаем SQL миграцию
scp migrate_conversations_unread_counters.sql root@178.172.212.221:/tmp/

echo "✅ SQL файл загружен на сервер"

echo ""
echo "Теперь ВЫПОЛНИТЕ НА СЕРВЕРЕ (введите пароль):"
echo ""
echo "ssh root@178.172.212.221"
echo ""
echo "sudo -u postgres psql your_donor < /tmp/migrate_conversations_unread_counters.sql"
echo ""
echo "После выполнения вы увидите:"
echo "  ALTER TABLE"
echo "  UPDATE X (где X - количество обновлённых диалогов)"
echo "  Обновлено диалогов | total | total_donor_unread | total_medcenter_unread"
echo ""
read -p "Нажмите Enter после выполнения миграции на сервере..."

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 ШАГ 2: СОХРАНЕНИЕ ВЕРСИИ v40.1"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

git add -A
git commit -m "fix: счётчики непрочитанных сообщений + документация автообновления"
git tag -a v40.1-stable -m "Стабильная версия: всё работает, счётчики исправлены"

echo "✅ Версия v40.1-stable сохранена в Git"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 ШАГ 3: ПРОВЕРКА СЧЁТЧИКОВ"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

echo ""
echo "На сервере выполните:"
echo ""
echo "sudo -u postgres psql your_donor -c \"SELECT id, donor_id, medical_center_id, donor_unread_count, medcenter_unread_count FROM conversations LIMIT 5;\""
echo ""
echo "Должны увидеть колонки с числами (не NULL)"
echo ""
read -p "Нажмите Enter для продолжения..."

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "✅ ИСПРАВЛЕНИЕ ЗАВЕРШЕНО!"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "🧪 ТЕСТИРОВАНИЕ:"
echo "  1. Откройте мессенджер на сайте"
echo "  2. Должны увидеть счётчики непрочитанных сообщений"
echo ""
echo "📖 ДОКУМЕНТАЦИЯ:"
echo "  • AUTO_REFRESH_RESEARCH.md - исследование автообновления"
echo "  • migrate_conversations_unread_counters.sql - выполненная миграция"
echo ""
echo "⏭️  СЛЕДУЮЩИЙ ШАГ:"
echo "  Прочитайте AUTO_REFRESH_RESEARCH.md и решите:"
echo "  - Хотите ли автообновление данных без перезагрузки?"
echo "  - Или добавить кнопку 'Обновить'?"
echo ""
echo "  Это БЕЗОПАСНО реализовать (не сломает сайт)"
echo ""
