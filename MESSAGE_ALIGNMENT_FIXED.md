# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ö–ª–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å–ø—Ä–∞–≤–∞ —É –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞!

## üéØ –ü–†–û–ë–õ–ï–ú–ê

**–°–∏–º–ø—Ç–æ–º:**
–ö–ª–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞ (–æ–¥–æ–±—Ä–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–æ–Ω–æ—Ä–∞) –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å **—Å–ª–µ–≤–∞** –≤ —á–∞—Ç–µ –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞, –∫–∞–∫ –±—É–¥—Ç–æ –∏—Ö –Ω–∞–ø–∏—Å–∞–ª –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π.

**–û–∂–∏–¥–∞–ª–æ—Å—å:**
–≠—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **—Å–ø—Ä–∞–≤–∞** (—Å–∏–Ω–∏–µ), —Ç–∞–∫ –∫–∞–∫ –∏—Ö –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ–¥—Ü–µ–Ω—Ç—Ä.

---

## üîç –ü–†–ò–ß–ò–ù–ê

**–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "—Å–≤–æ–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π:**

```javascript
// messenger.js, —Å—Ç—Ä–æ–∫–∞ 386
const isOwn = msg.sender_role === this.userRole;
```

**–î–ª—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞:**
- `this.userRole = 'medical_center'`
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞, –µ—Å–ª–∏: `msg.sender_role === 'medical_center'`

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ backend:**

```python
# app.py - –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
query_db(
    """INSERT INTO messages 
       (conversation_id, sender_id, sender_role, content, message_type, ...)
       VALUES (%s, NULL, 'system', %s, 'notification', ...)""",  # ‚ùå 'system'
    ...
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `msg.sender_role = 'system'`
- `'system' !== 'medical_center'` ‚ùå
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–ª–µ–≤–∞ (–∫–∞–∫ —á—É–∂–æ–µ)

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –¥–æ–Ω–æ—Ä–∞

**–§–∞–π–ª:** `website/backend/app.py` (—Å—Ç—Ä–æ–∫–∞ 2505)

**–î–û:**
```python
VALUES (%s, NULL, 'system', %s, 'notification', %s, NOW())
                  ^^^^^^^^
```

**–ü–û–°–õ–ï:**
```python
VALUES (%s, NULL, 'medical_center', %s, 'notification', %s, NOW())
                  ^^^^^^^^^^^^^^^^
```

**Endpoint:** `POST /api/medcenter/responses/<id>/approve`

---

### 2. –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –¥–æ–Ω–æ—Ä–∞

**–§–∞–π–ª:** `website/backend/app.py` (—Å—Ç—Ä–æ–∫–∞ 2605)

**–î–û:**
```python
VALUES (%s, NULL, 'system', %s, 'notification', %s, NOW())
                  ^^^^^^^^
```

**–ü–û–°–õ–ï:**
```python
VALUES (%s, NULL, 'medical_center', %s, 'notification', %s, NOW())
                  ^^^^^^^^^^^^^^^^
```

**Endpoint:** `POST /api/medcenter/responses/<id>/reject`

---

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)

**–§–∞–π–ª:** `website/backend/migrations/fix_message_sender_role.sql`

```sql
UPDATE messages
SET sender_role = 'medical_center'
WHERE sender_role = 'system'
  AND message_type IN ('notification', 'invitation');
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∞:** ‚úÖ
```
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 0
```
(0 –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ `medical_center`)

---

## üé® –ö–ê–ö –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–ï–¢

### –û–¥–æ–±—Ä–µ–Ω–∏–µ –¥–æ–Ω–æ—Ä–∞:

```
1. –ú–µ–¥—Ü–µ–Ω—Ç—Ä –æ–¥–æ–±—Ä—è–µ—Ç –¥–æ–Ω–æ—Ä–∞
   ‚Üì
2. Backend —Å–æ–∑–¥–∞—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:
   - sender_role: 'medical_center'  ‚úÖ
   - message_type: 'notification'
   - content: "‚úÖ –í–ê–®–ê –ó–ê–Ø–í–ö–ê –û–î–û–ë–†–ï–ù–ê!..."
   ‚Üì
3. Frontend (messenger.js):
   - msg.sender_role = 'medical_center'
   - this.userRole = 'medical_center' (–¥–ª—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞)
   - isOwn = true ‚úÖ
   ‚Üì
4. –†–µ–Ω–¥–µ—Ä:
   - class="message own"
   - –°–∏–Ω–∏–π –ø—É–∑—ã—Ä—å
   - –°–ø—Ä–∞–≤–∞ ‚úÖ
```

### –í —á–∞—Ç–µ –¥–æ–Ω–æ—Ä–∞:

```
1. –î–æ–Ω–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
   ‚Üì
2. Frontend (messenger.js):
   - msg.sender_role = 'medical_center'
   - this.userRole = 'donor' (–¥–ª—è –¥–æ–Ω–æ—Ä–∞)
   - isOwn = false ‚ùå
   ‚Üì
3. –†–µ–Ω–¥–µ—Ä:
   - class="message other"
   - –°–µ—Ä—ã–π –ø—É–∑—ã—Ä—å
   - –°–ª–µ–≤–∞ ‚úÖ
```

**–ò–¥–µ–∞–ª—å–Ω–æ!**

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢

| –†–æ–ª—å | –°–æ–æ–±—â–µ–Ω–∏—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞ | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ |
|------|---------------------|--------------|
| **–ú–µ–¥—Ü–µ–Ω—Ç—Ä** | sender_role = 'medical_center' | **–°–ø—Ä–∞–≤–∞ (—Å–∏–Ω–∏–µ)** ‚úÖ |
| **–î–æ–Ω–æ—Ä** | sender_role = 'medical_center' | **–°–ª–µ–≤–∞ (—Å–µ—Ä—ã–µ)** ‚úÖ |

---

## üß™ –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
```
Ctrl+Shift+R  (Windows/Linux)
Cmd+Shift+R   (Mac)
```

### –®–∞–≥ 2: –ú–µ–¥—Ü–µ–Ω—Ç—Ä –æ–¥–æ–±—Ä—è–µ—Ç –¥–æ–Ω–æ—Ä–∞

1. **–í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –º–µ–¥—Ü–µ–Ω—Ç—Ä**
2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–û—Ç–∫–ª–∏–∫–∏ –¥–æ–Ω–æ—Ä–æ–≤"**
3. **–û–¥–æ–±—Ä–∏—Ç–µ –¥–æ–Ω–æ—Ä–∞** (—É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è)
4. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–°–æ–æ–±—â–µ–Ω–∏—è"**

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

**–í —á–∞—Ç–µ –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞:**
- ‚úÖ –ö–ª–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–ê–®–ê –ó–ê–Ø–í–ö–ê –û–î–û–ë–†–ï–ù–ê" - **–°–ü–†–ê–í–ê** (—Å–∏–Ω–µ–µ)

**–í —á–∞—Ç–µ –¥–æ–Ω–æ—Ä–∞:**
- ‚úÖ –¢–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - **–°–õ–ï–í–ê** (—Å–µ—Ä–æ–µ)

---

## üìù –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### 1. `website/backend/app.py`
**–°—Ç—Ä–æ–∫–∞ 2505:** `'system'` ‚Üí `'medical_center'`
**–°—Ç—Ä–æ–∫–∞ 2605:** `'system'` ‚Üí `'medical_center'`

### 2. `website/backend/migrations/fix_message_sender_role.sql`
**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üéâ –ò–¢–û–ì

**–ë—ã–ª–æ:**
- ‚ùå –ö–ª–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å —Å–ª–µ–≤–∞ (–∫–∞–∫ —á—É–∂–∏–µ)
- ‚ùå sender_role = 'system'

**–°—Ç–∞–ª–æ:**
- ‚úÖ –ö–ª–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–ø—Ä–∞–≤–∞ (–∫–∞–∫ —Å–≤–æ–∏)
- ‚úÖ sender_role = 'medical_center'
- ‚úÖ –£ –¥–æ–Ω–æ—Ä–∞ —ç—Ç–∏ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è - —Å–ª–µ–≤–∞ (–∫–∞–∫ —á—É–∂–∏–µ)

**–ú–ï–°–°–ï–ù–î–ñ–ï–† –†–ê–ë–û–¢–ê–ï–¢ –ò–î–ï–ê–õ–¨–ù–û!** ‚ú®üéâ

---

## üí° –õ–û–ì–ò–ö–ê

**–ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**
```
isOwn = (msg.sender_role === this.userRole)
```

**–î–ª—è –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞:**
- –°–≤–æ—è —Ä–æ–ª—å: `medical_center`
- –°–æ–æ–±—â–µ–Ω–∏—è —Å `sender_role = 'medical_center'` ‚Üí —Å–ø—Ä–∞–≤–∞ ‚úÖ

**–î–ª—è –¥–æ–Ω–æ—Ä–∞:**
- –°–≤–æ—è —Ä–æ–ª—å: `donor`
- –°–æ–æ–±—â–µ–Ω–∏—è —Å `sender_role = 'donor'` ‚Üí —Å–ø—Ä–∞–≤–∞ ‚úÖ
- –°–æ–æ–±—â–µ–Ω–∏—è —Å `sender_role = 'medical_center'` ‚Üí —Å–ª–µ–≤–∞ ‚úÖ

**–í–°–Å –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û!** üéØ
