#!/bin/bash

# ============================================
# –¢–≤–æ–π –î–æ–Ω–æ—Ä - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
# ============================================
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
# —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ:
# 1. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã –ë–î (sender_role ‚Üí sender_type, message ‚Üí message_text)
# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ frontend (renderNotificationMessage)
#
# –ê–≤—Ç–æ—Ä: AI Assistant
# –î–∞—Ç–∞: 2026-01-26
# ============================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
SERVER_IP="178.172.212.221"
SERVER_USER="root"
SERVER_PATH="/opt/tvoydonor/website"
DB_NAME="your_donor"
DB_USER="donor_user"

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë   üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê          ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "website/js" ]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞!${NC}"
    exit 1
fi

echo -e "${BLUE}üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:${NC}"
echo "  1. –°—Ö–µ–º–∞ –ë–î –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É (sender_role vs sender_type)"
echo "  2. –ö–ª–∏—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–ª–µ–≤–∞ (–¥–æ–ª–∂–Ω—ã —Å–ø—Ä–∞–≤–∞)"
echo "  3. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–π = undefined"
echo ""

echo -e "${YELLOW}‚ö†Ô∏è  –í–ê–ñ–ù–û: –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Ç–∞–±–ª–∏—Ü—ã chat_messages!${NC}"
echo ""

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º${NC}"
    exit 1
fi

# ============================================
# –®–ê–ì 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# ============================================

echo -e "${YELLOW}üì§ –®–ê–ì 1/4: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏...${NC}"

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º SQL –º–∏–≥—Ä–∞—Ü–∏—é..."
scp migrate_chat_messages.sql ${SERVER_USER}@${SERVER_IP}:/tmp/

echo "  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π messenger.js..."
scp website/js/messenger.js ${SERVER_USER}@${SERVER_IP}:${SERVER_PATH}/js/

echo -e "${GREEN}‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã${NC}"
echo ""

# ============================================
# –®–ê–ì 2: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
# ============================================

echo -e "${YELLOW}üóÑÔ∏è  –®–ê–ì 2/4: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
echo ""

ssh ${SERVER_USER}@${SERVER_IP} << EOF
    set -e
    
    echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã..."
    PGPASSWORD="${DB_PASSWORD:-DonorSecure2026!Pass}" psql -U ${DB_USER} -d ${DB_NAME} -c "\d chat_messages"
    
    echo ""
    echo "üîÑ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é..."
    PGPASSWORD="${DB_PASSWORD:-DonorSecure2026!Pass}" psql -U ${DB_USER} -d ${DB_NAME} -f /tmp/migrate_chat_messages.sql
    
    echo ""
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    rm /tmp/migrate_chat_messages.sql
EOF

echo -e "${GREEN}‚úÖ –ë–î —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞${NC}"
echo ""

# ============================================
# –®–ê–ì 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π (cache-busting)
# ============================================

echo -e "${YELLOW}üîÑ –®–ê–ì 3/4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π...${NC}"

TIMESTAMP=$(date +%s)
echo "  ‚Ä¢ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${TIMESTAMP}"

ssh ${SERVER_USER}@${SERVER_IP} << EOF
    cd ${SERVER_PATH}
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ config.js
    sed -i "s/window.VERSION = .*/window.VERSION = '${TIMESTAMP}';/" js/config.js
    
    echo "‚úÖ –í–µ—Ä—Å–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
EOF

echo -e "${GREEN}‚úÖ Cache-busting –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
echo ""

# ============================================
# –®–ê–ì 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
# ============================================

echo -e "${YELLOW}üîÑ –®–ê–ì 4/4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤...${NC}"

ssh ${SERVER_USER}@${SERVER_IP} << 'EOF'
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
    nginx -t
    
    if [ $? -eq 0 ]; then
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
        systemctl reload nginx
        echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!"
        exit 1
    fi
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º API (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    supervisorctl restart tvoydonor-api
    echo "‚úÖ API –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
EOF

echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã${NC}"
echo ""

# ============================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢
# ============================================

echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${GREEN}‚ïë   ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!            ‚ïë${NC}"
echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

echo -e "${BLUE}üìä –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:${NC}"
echo "  ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –ë–î: sender_role ‚Üí sender_type, message ‚Üí message_text"
echo "  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ message_type"
echo "  ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω renderNotificationMessage –≤ messenger.js"
echo "  ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: chat_messages_backup"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤–µ—Ä—Å–∏–∏ –¥–ª—è cache-busting"
echo "  ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã Nginx –∏ API"
echo ""

echo -e "${BLUE}üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:${NC}"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç: https://tvoydonor.by"
echo "  2. –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –∫–∞–∫ –º–µ–¥—Ü–µ–Ω—Ç—Ä"
echo "  3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ–Ω–æ—Ä–∞ (–æ—Ç–ø—Ä–∞–≤–∏—Ç –∫–ª–∏—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)"
echo "  4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä:"
echo "     ‚úÖ –ö–ª–∏—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –°–ü–†–ê–í–ê (—É –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞)"
echo "     ‚úÖ –£ –¥–æ–Ω–æ—Ä–∞ —ç—Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –°–õ–ï–í–ê"
echo "  5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞"
echo "     ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –°–ü–†–ê–í–ê (—É –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞)"
echo "  6. –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –∫–∞–∫ –¥–æ–Ω–æ—Ä –∏ –æ—Ç–≤–µ—Ç—å—Ç–µ"
echo "     ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–Ω–æ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –°–ü–†–ê–í–ê (—É –¥–æ–Ω–æ—Ä–∞)"
echo "     ‚úÖ –£ –º–µ–¥—Ü–µ–Ω—Ç—Ä–∞ —ç—Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –°–õ–ï–í–ê"
echo ""

echo -e "${YELLOW}‚ö†Ô∏è  –í–ê–ñ–ù–û:${NC}"
echo "  ‚Ä¢ –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é, –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à: Ctrl+Shift+R"
echo "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏ (F12)"
echo "  ‚Ä¢ –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f /var/log/tvoydonor-api.err.log"
echo ""

echo -e "${BLUE}üîÑ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫):${NC}"
echo "  ssh root@${SERVER_IP}"
echo "  sudo -u postgres psql -d ${DB_NAME}"
echo "  DROP TABLE chat_messages;"
echo "  ALTER TABLE chat_messages_backup RENAME TO chat_messages;"
echo ""

echo -e "${GREEN}üéâ –ì–æ—Ç–æ–≤–æ! –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!${NC}"
