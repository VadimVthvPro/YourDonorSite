# Твой Донор

Современная веб-платформа для связи доноров крови с медицинскими учреждениями Беларуси. Система позволяет медицинским центрам создавать запросы на донацию крови, а донорам оперативно реагировать на них через удобный веб-интерфейс и Telegram-бот.

## Описание проекта

Твой Донор - это полнофункциональная платформа, которая решает проблему координации между донорами и медицинскими учреждениями. Система включает адаптивный веб-интерфейс, REST API на Flask и интеграцию с Telegram для мгновенных уведомлений.

### Основные возможности

**Для доноров:**
- Регистрация с указанием группы крови, контактных данных и истории донаций
- Просмотр актуальных запросов крови от медицинских центров
- Донорский светофор (визуализация срочности запросов по группам крови)
- Отклик на запросы с указанием предпочтительной даты
- Личный мессенджер для связи с медцентрами
- Статистика донаций и управление профилем
- Telegram-бот для получения уведомлений о срочных запросах
- Возможность запланировать донацию в любое удобное время

**Для медицинских центров:**
- Регистрация и управление профилем учреждения
- Создание запросов крови с указанием группы и срочности
- Управление донорским светофором (нормальная/средняя/критическая нехватка)
- Просмотр и обработка откликов доноров
- База данных зарегистрированных доноров с фильтрацией
- Встроенный мессенджер для общения с донорами
- Шаблоны сообщений для быстрой коммуникации
- Массовая рассылка уведомлений
- Статистика по донациям

### Технологический стек

**Backend:**
- Python 3.8+ с Flask
- PostgreSQL 12+ для хранения данных
- python-telegram-bot для интеграции с Telegram
- psycopg2 для работы с базой данных
- Flask-CORS для кросс-доменных запросов

**Frontend:**
- Чистый JavaScript (ES6+) без фреймворков
- Адаптивный дизайн с CSS3 (Flexbox, Grid)
- Система компонентов и модальных окон
- Long Polling для реального времени в мессенджере

**Инфраструктура:**
- REST API с JWT-подобной аутентификацией
- Система миграций базы данных
- Логирование и обработка ошибок
- Конфигурация через переменные окружения

## Быстрый старт

### Системные требования

Перед установкой убедитесь, что у вас установлены:
- Python 3.8 или выше
- PostgreSQL 12 или выше
- Git
- Доступ к интернету для установки зависимостей

### Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd Your_donor
```

2. Установите зависимости Python:
```bash
cd website/backend
pip install -r requirements.txt
```

3. Настройте базу данных PostgreSQL:
```bash
# Подключитесь к PostgreSQL
psql -U postgres

# Создайте базу данных
CREATE DATABASE your_donor;
\q

# Выполните миграции
psql -U postgres -d your_donor -f create_database.sql
```

4. Настройте переменные окружения:
```bash
# Скопируйте пример конфигурации
cp env_example.txt .env

# Откройте .env и заполните все необходимые значения
# См. подробную инструкцию в ENV_SETUP_GUIDE.md
```

5. Запустите серверы:
```bash
# Терминал 1: Flask API
cd website/backend
python3 app.py

# Терминал 2: Telegram бот
cd website/backend
python3 telegram_bot.py

# Терминал 3: Frontend (HTTP сервер)
cd website
python3 -m http.server 8080
```

6. Откройте браузер и перейдите по адресу:
```
http://localhost:8080
```

## Структура проекта

```
Your_donor/
├── website/
│   ├── backend/
│   │   ├── app.py                      # Основной Flask API
│   │   ├── telegram_bot.py             # Telegram бот
│   │   ├── messaging_api.py            # API мессенджера (диалоги)
│   │   ├── messaging_api_messages.py   # API мессенджера (сообщения)
│   │   ├── create_database.sql         # Основная схема БД
│   │   ├── migrations/                 # SQL миграции
│   │   └── requirements.txt            # Python зависимости
│   ├── css/
│   │   ├── styles.css                  # Общие стили
│   │   ├── dashboard.css               # Стили дашборда
│   │   ├── messenger.css               # Стили мессенджера
│   │   └── ...                         # Другие стили
│   ├── js/
│   │   ├── app.js                      # Главная логика
│   │   ├── auth.js                     # Аутентификация
│   │   ├── donor-dashboard.js          # Дашборд донора
│   │   ├── medcenter-dashboard.js      # Дашборд медцентра
│   │   └── messenger.js                # Логика мессенджера
│   ├── pages/
│   │   ├── auth.html                   # Страница регистрации/входа
│   │   ├── donor-dashboard.html        # Дашборд донора
│   │   └── medcenter-dashboard.html    # Дашборд медцентра
│   └── index.html                      # Главная страница
├── DONATION_PREPARATION_RULES.md       # Правила подготовки к донации
├── ENV_SETUP_GUIDE.md                  # Подробная инструкция по .env
├── DEPLOYMENT.md                       # Инструкция по деплою
├── env_example.txt                     # Пример конфигурации
└── README.md                           # Этот файл
```

## Конфигурация

Все секретные данные и настройки хранятся в файле `.env`. Основные параметры:

- `DB_*` - настройки подключения к PostgreSQL
- `SECRET_KEY` - секретный ключ Flask для сессий
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота от @BotFather
- `WEBSITE_URL` - URL платформы (должен быть HTTPS для Telegram WebApp)
- `APP_URL` - URL API для внутренних запросов
- `MASTER_PASSWORD` - мастер-пароль для регистрации медцентров
- `FLASK_DEBUG` - режим отладки (в продакшене должен быть `false`)

Подробная инструкция по настройке всех параметров находится в файле `ENV_SETUP_GUIDE.md`.

## Основные функции

### Система аутентификации
Раздельная аутентификация для доноров и медицинских центров с использованием токенов сессий. Доноры могут привязать Telegram для получения уведомлений через специальный 6-значный код.

### Донорский светофор
Визуальная система индикации срочности запросов крови по каждой группе. Медцентры управляют статусом (нормальная/средняя/критическая нехватка), что отображается цветовыми индикаторами для доноров.

### Система запросов и откликов
Медцентры создают запросы крови, доноры откликаются с указанием удобной даты. Есть возможность создания обычных и срочных запросов с автоматическим уведомлением в Telegram.

### Встроенный мессенджер
Полнофункциональный чат между донорами и медцентрами с поддержкой различных типов сообщений (текст, уведомления, приглашения). Включает список диалогов, счетчики непрочитанных сообщений, поиск и реальное время обновлений через Long Polling.

### Telegram интеграция
Бот отправляет уведомления о:
- Срочных запросах крови подходящей группы
- Одобрении/отклонении заявок донора
- Новых сообщениях от медцентров
- Напоминаниях о запланированных донациях

Бот поддерживает команды `/start`, `/help`, `/link`, `/status` и автоматическое подтверждение регистрации по коду.

### Статистика и аналитика
Для доноров: история донаций, статистика по количеству, визуализация активности.
Для медцентров: количество откликов, активные доноры, статистика по запросам.

## Безопасность

- Все пароли хранятся в зашифрованном виде (bcrypt)
- Токены сессий с истечением срока действия
- Защита от SQL-инъекций через параметризованные запросы
- CORS настроен для работы только с доверенными источниками
- Валидация всех входных данных на сервере
- Секретные данные в переменных окружения (.env не коммитится в Git)

## Развертывание

Подробная инструкция по развертыванию на продакшен-сервере находится в файле `DEPLOYMENT.md`. Основные шаги:

1. Настройка сервера (Linux/Ubuntu рекомендуется)
2. Установка и настройка PostgreSQL
3. Настройка Nginx как reverse proxy
4. Установка SSL сертификата (Let's Encrypt)
5. Настройка systemd для автозапуска сервисов
6. Конфигурация Telegram WebApp с HTTPS

## Лицензия и использование

Проект создан в образовательных целях для демонстрации современных веб-технологий и работы с API. При использовании в реальных медицинских условиях необходима консультация со специалистами здравоохранения и соблюдение всех нормативных требований.

## Контакты и поддержка

Для вопросов по установке и использованию см. файл `ENV_SETUP_GUIDE.md` и `DEPLOYMENT.md`.

---

**Важное примечание:** Система предназначена для координации доноров и медицинских учреждений. Все медицинские решения должны приниматься квалифицированными специалистами. Платформа не заменяет профессиональную медицинскую консультацию.
