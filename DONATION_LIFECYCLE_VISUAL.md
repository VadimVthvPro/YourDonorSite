# 🔄 ВИЗУАЛЬНАЯ СХЕМА: Жизненный цикл донации

```
┌────────────────────────────────────────────────────────────────────────┐
│                    ШАГ 1: СОЗДАНИЕ ЗАПРОСА                             │
└────────────────────────────────────────────────────────────────────────┘

    🏥 Медцентр
    │
    ├─► Создаёт запрос: "Нужна кровь O+, срочно!"
    │
    └─► INSERT INTO blood_requests
        (medical_center_id, blood_type='O+', urgency='urgent', status='active')

    📲 Telegram: Уведомления отправлены донорам O+ ✅


┌────────────────────────────────────────────────────────────────────────┐
│                    ШАГ 2: ОТКЛИК ДОНОРА                                │
└────────────────────────────────────────────────────────────────────────┘

    🩸 Донор (O+)
    │
    ├─► Видит запрос, нажимает "Откликнуться"
    │
    ├─► Проверка: Прошло ли 60 дней с последней донации?
    │   ├─► ДА  → Можно откликнуться ✅
    │   └─► НЕТ → Ошибка 403: "Осталось X дней" ❌
    │
    └─► INSERT INTO donation_responses
        (request_id, user_id, status='pending', donor_comment)

    🏥 Медцентр видит отклик в разделе "Отклики"


┌────────────────────────────────────────────────────────────────────────┐
│                    ШАГ 3: ОДОБРЕНИЕ ДОНОРА                             │
└────────────────────────────────────────────────────────────────────────┘

    🏥 Медцентр
    │
    ├─► Видит список откликнувшихся доноров
    │
    ├─► Выбирает подходящих, нажимает "Одобрить"
    │
    ├─► UPDATE donation_responses
    │   SET status='confirmed', donation_date='2026-02-15', donation_time='10:00'
    │
    ├─► INSERT INTO conversations (создаётся диалог) ✅
    │
    ├─► INSERT INTO chat_messages (приглашение на донацию) ✅
    │
    └─► 📲 Telegram: "Вы одобрены! 2026-02-15, 10:00" ✅

    🩸 Донор получает уведомление и приглашение


┌────────────────────────────────────────────────────────────────────────┐
│                    ШАГ 4: ЗАВЕРШЕНИЕ ДОНАЦИИ                           │
└────────────────────────────────────────────────────────────────────────┘

    🩸 Донор приходит в медцентр, сдаёт кровь ✅
    │
    │
    🏥 Медцентр нажимает "Донация выполнена"
    │
    ├─► UPDATE donation_responses
    │   SET status='completed', donation_completed=TRUE, actual_donation_date=NOW()
    │
    ├─► ⚡ ТРИГГЕР: Обновление статистики донора
    │   │
    │   ├─► UPDATE users SET
    │   │   ├─ last_donation_date = CURRENT_DATE    (Таймер 60 дней ✅)
    │   │   ├─ total_donations += 1                 (Счётчик донаций ✅)
    │   │   └─ total_volume_ml += 450               (Объём крови ✅)
    │   │
    │   └─► INSERT INTO donation_history             (История ✅)
    │       ├─ donor_id            = X
    │       ├─ medical_center_id   = Y
    │       ├─ donation_date        = CURRENT_DATE
    │       ├─ blood_type           = 'O+'          ✅ ВАЖНО!
    │       ├─ volume_ml            = 450
    │       ├─ donation_type        = 'blood'
    │       ├─ status               = 'completed'   ✅ ВАЖНО!
    │       └─ response_id          = Z             ✅ ВАЖНО!
    │
    └─► ✅ ГОТОВО! Статистика обновлена!


┌────────────────────────────────────────────────────────────────────────┐
│                    ШАГ 5: ПРОСМОТР СТАТИСТИКИ                          │
└────────────────────────────────────────────────────────────────────────┘

    🩸 ДОНОР открывает раздел "Статистика"
    │
    ├─► GET /api/donor/statistics
    │   │
    │   ├─► SELECT * FROM users WHERE id=X
    │   │   └─► total_donations=1, last_donation_date='2026-01-26' ✅
    │   │
    │   └─► SELECT * FROM donation_history WHERE donor_id=X
    │       └─► [{ donation_date:'2026-01-26', medical_center_name:'...' }] ✅
    │
    ├─► ✅ Отображается:
    │   ├─ Общее количество донаций: 1
    │   ├─ Последняя донация: 2026-01-26
    │   ├─ График по месяцам: [1 донация в январе]
    │   ├─ Таймер: "Можно сдать через 60 дней" ⏱️
    │   └─ Спасённые жизни: 3 (1 донация × 3)
    │
    └─► 🎉 ВСЁ РАБОТАЕТ!


    🏥 МЕДЦЕНТР открывает раздел "Статистика"
    │
    ├─► GET /api/medical-center/statistics?period=month
    │   │
    │   └─► SELECT COUNT(*), SUM(volume_ml)
    │       FROM donation_history
    │       WHERE medical_center_id=Y
    │       AND donation_date BETWEEN ... ✅
    │       GROUP BY blood_type
    │
    ├─► ✅ Отображается:
    │   ├─ Количество донаций: 1
    │   ├─ Объём крови: 450 мл
    │   ├─ Диаграмма по группам крови: O+ = 1 ✅
    │   └─ Диаграмма запросов: urgent = 1
    │
    └─► 🎉 ВСЁ РАБОТАЕТ!


┌────────────────────────────────────────────────────────────────────────┐
│                    ШАГ 6: ПОВТОРНЫЙ ОТКЛИК (ПРОВЕРКА)                  │
└────────────────────────────────────────────────────────────────────────┘

    🩸 Донор пытается откликнуться на новый запрос (на следующий день)
    │
    ├─► POST /api/donor/blood-requests/<id>/respond
    │   │
    │   ├─► SELECT last_donation_date FROM users WHERE id=X
    │   │   └─► last_donation_date = '2026-01-26'
    │   │
    │   ├─► days_since = (TODAY - '2026-01-26').days = 1
    │   │
    │   └─► IF days_since < 60:
    │       └─► ❌ ОШИБКА 403:
    │           "Нельзя откликнуться! С последней донации прошло только 1 день.
    │            Минимум 60 дней между донациями."
    │
    └─► ⏱️ ТАЙМЕР РАБОТАЕТ! ✅


┌────────────────────────────────────────────────────────────────────────┐
│                         ИТОГОВАЯ СХЕМА БД                              │
└────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐
│   blood_requests    │
│─────────────────────│
│ id                  │
│ medical_center_id   │◄────┐
│ blood_type          │     │
│ urgency             │     │
│ status (active)     │     │
└─────────────────────┘     │
         ▲                  │
         │                  │
         │                  │
┌─────────────────────┐     │
│ donation_responses  │     │
│─────────────────────│     │
│ id                  │     │
│ request_id ─────────┘     │
│ user_id             │     │
│ medical_center_id ──┼─────┤
│ status (completed)  │     │
└─────────────────────┘     │
         │                  │
         │ response_id      │
         ▼                  │
┌─────────────────────┐     │
│  donation_history   │     │
│─────────────────────│     │
│ id                  │     │
│ donor_id            │     │
│ medical_center_id ──┼─────┘
│ donation_date       │
│ blood_type ✅       │  ◄── ДОБАВЛЕНО!
│ volume_ml           │
│ status ✅           │  ◄── ДОБАВЛЕНО!
│ response_id ✅      │  ◄── ДОБАВЛЕНО!
└─────────────────────┘
         │
         │ donor_id
         ▼
┌─────────────────────┐
│       users         │
│─────────────────────│
│ id                  │
│ blood_type          │
│ last_donation_date ✅│  ◄── ОБНОВЛЯЕТСЯ!
│ total_donations ✅  │  ◄── УВЕЛИЧИВАЕТСЯ!
│ total_volume_ml ✅  │  ◄── УВЕЛИЧИВАЕТСЯ!
└─────────────────────┘


┌────────────────────────────────────────────────────────────────────────┐
│                         ЧТО БЫЛО ИСПРАВЛЕНО                            │
└────────────────────────────────────────────────────────────────────────┘

❌ БЫЛО:
   donation_history:
   - user_id              (не совпадает с кодом!)
   - blood_center_id      (не совпадает с кодом!)
   - НЕТ blood_type       (нужно для статистики медцентра!)
   - НЕТ status           (нужно для фильтрации!)
   - НЕТ response_id      (нужно для связи!)

✅ СТАЛО:
   donation_history:
   - donor_id ✅          (совпадает с app.py!)
   - medical_center_id ✅ (совпадает с app.py!)
   - blood_type ✅        (для статистики медцентра!)
   - status='completed' ✅(для фильтрации!)
   - response_id ✅       (для связи с откликом!)


┌────────────────────────────────────────────────────────────────────────┐
│                         РЕЗУЛЬТАТ                                      │
└────────────────────────────────────────────────────────────────────────┘

✅ Статистика донора работает
✅ Статистика медцентра работает
✅ Таймер 60 дней работает
✅ История донаций отображается
✅ Графики и диаграммы работают

🎉 ВСЁ РАБОТАЕТ КАК ЗАДУМАНО!
```
